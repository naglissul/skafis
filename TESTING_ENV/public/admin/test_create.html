<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Testavimo aplinka Skafis</title>
    <link rel="icon" type="image/x-icon" href="../logo/favicon.ico" />
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        onValue,
      } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDE6Yx4cXghxsn6FKOVEXYN8aavEzOipWA",
        authDomain: "kontrass.firebaseapp.com",
        databaseURL:
          "https://kontrass-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "kontrass",
        storageBucket: "kontrass.appspot.com",
        messagingSenderId: "691360022307",
        appId: "1:691360022307:web:b8d0cae3fd88b38e275696",
      };
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const auth = getAuth(app);

      let userEmail = "";
      onAuthStateChanged(auth, (user) => {
        if (user) {
          userEmail = user.email;
        } else {
          window.location.href = "admin_login.html";
        }
      });

      const createBtn = document.getElementById("createBtn");
      createBtn.addEventListener("click", () => {
        const testCode = document.getElementById("testCode").value;
        const testTitle = document.getElementById("testTitle").value;
        const testDescription =
          document.getElementById("testDescription")?.value;
        const testSpecialSymbols =
          document.getElementById("testSpecialSymbols")?.value;

        const newTestRef = ref(
          db,
          "/users/" + userEmail.replace(/\./g, "?") + "/tests/" + testCode
        );

        set(newTestRef, {
          lastModified: new Date().toISOString(),
          test: {
            title: testTitle,
            description: testDescription,
            specialSymbls: testSpecialSymbols,
            questions: getQuestions(),
          },
          isAccessible: false,
        })
          .then(() => {
            //TODO: create accessibleTest
            alert("Testas sukurtas sėkmingai!");
            window.location.href = "admin.html";
          })
          .catch((error) => {
            console.error("Error creating test: ", error);
            alert("Klaida: " + error.message);
          });
      });

      document
        .getElementById("addQuestionBtn")
        .addEventListener("click", addQuestion);
      function addQuestion(event) {
        event.preventDefault();
        const container = document.getElementById("questionsContainer");

        const newQuestionDiv = document.createElement("div");
        newQuestionDiv.innerHTML = `
        <div>
          <label>Klausimo numeris:</label><br />
          <input type="text" name="number" required />
        </div>
        <div>
          <label>Klausimas:</label><br />
          <input type="text" name="question" required />
        </div>
        <div>
          <label>Teisingas atsakymas / sprendimas:</label><br />
          <input type="text" name="correctAnswer" required />
        </div>
        <div>
          <label>Taškai:</label><br />
          <input type="number" name="points" required />
        </div>
        <div>
          <label>Užduotis yra papildoma:</label><br />
          <input type="checkbox" name="isAdditional" />
        </div>
        `;

        container.appendChild(newQuestionDiv);
      }

      function getQuestions() {
        let allQuestionDivs = document.querySelectorAll(
          "#questionsContainer > div"
        );
        let questions = [];

        allQuestionDivs.forEach((div) => {
          const question = {
            number: div.querySelector('[name="number"]').value,
            question: div.querySelector('[name="question"]').value,
            correctAnswer: div.querySelector('[name="correctAnswer"]').value,
            points: parseInt(div.querySelector('[name="points"]').value, 10),
            isAdditional: div.querySelector('[name="isAdditional"]').checked,
          };
          questions.push(question);
        });

        return questions;
      }
    </script>
  </head>
  <body>
    <h1>Naujas testas</h1>
    <label for="testCode">Testo kodas</label><br />
    <input
      type="text"
      id="testCode"
      pattern="[A-Z]*"
      oninput="this.value = this.value.toUpperCase()"
    /><br />
    <label for="testTitle">Testo pavadinimas (rodomas mokiniams)</label><br />
    <input type="text" id="testTitle" required /> <br />
    <label for="testDescription">Testo aprašymas (rodomas mokiniams)</label
    ><br />
    <textarea type="text" id="testDescription"></textarea><br />
    <label for="testSpecialSymbols"
      >Simbolių sąrašas kopijavimui (pateikiamas mokiniams stambiu formatu
      kopijavimui)</label
    ><br />
    <input type="text" id="testSpecialSymbols" /><br />
    <label for="questionsContainer">Klausimai</label><br />
    <div id="questionsContainer">
      <div>
        <div>
          <label>Klausimo numeris:</label><br />
          <input type="text" name="number" required />
        </div>
        <div>
          <label>Klausimas:</label><br />
          <input type="text" name="question" required />
        </div>
        <div>
          <label>Teisingas atsakymas / sprendimas:</label><br />
          <input type="text" name="correctAnswer" required />
        </div>
        <div>
          <label>Taškai:</label><br />
          <input type="number" name="points" required />
        </div>
        <div>
          <label>Užduotis yra papildoma:</label><br />
          <input type="checkbox" name="isAdditional" />
        </div>
      </div>
    </div>
    <button type="button" id="addQuestionBtn">Pridėti klausimą</button>
    <button id="createBtn">Sukurti testą (dar neviešinama)</button>
  </body>
</html>
