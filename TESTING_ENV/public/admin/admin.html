<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Testavimo aplinka Skafis</title>
    <link rel="icon" type="image/x-icon" href="../logo/favicon.ico" />

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        onValue,
      } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDE6Yx4cXghxsn6FKOVEXYN8aavEzOipWA",
        authDomain: "kontrass.firebaseapp.com",
        databaseURL:
          "https://kontrass-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "kontrass",
        storageBucket: "kontrass.appspot.com",
        messagingSenderId: "691360022307",
        appId: "1:691360022307:web:b8d0cae3fd88b38e275696",
      };
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const auth = getAuth(app);

      let userEmail = "";
      let testListRef;
      onAuthStateChanged(auth, (user) => {
        if (user) {
          const signOutButton = document.getElementById("signOutButton");
          signOutButton.style.display = "block";
          const isLoggedInDiv = document.getElementById("isLoggedIn");
          isLoggedInDiv.innerHTML = `Esate prisijungę kaip ${user.email}`;

          userEmail = user.email;
          const userRef = ref(
            db,
            "users/" + userEmail.replace(/\./g, "?") + "/tests"
          );
          onValue(userRef, (snapshot) => {
            const tests = snapshot.val();
            const testList = document.getElementById("testList");
            testList.innerHTML = "";

            for (const key in tests) {
              if (tests.hasOwnProperty(key)) {
                const testItem = document.createElement("div");
                const viewTestLink = document.createElement("a");
                viewTestLink.textContent = `"${tests[key].test.title}" (kodas: ${key})`;
                viewTestLink.href = `test_dashboard.html?testCode=${key}`;
                testItem.appendChild(viewTestLink);

                if (tests[key].isAccessible) {
                  const strongElement = document.createElement("strong");
                  strongElement.innerHTML = " - Viešas.";
                  testItem.appendChild(strongElement);

                  const unpublishTestBtn = document.createElement("button");
                  unpublishTestBtn.textContent = "Užprivatinti";
                  unpublishTestBtn.addEventListener("click", () => {
                    alert("One day this will unpublish stuff");
                  });
                  testItem.appendChild(unpublishTestBtn);
                } else {
                  const strongElement = document.createElement("strong");
                  strongElement.innerHTML = " - Privatus.";
                  testItem.appendChild(strongElement);

                  const publishTestBtn = document.createElement("button");
                  publishTestBtn.textContent = "Viešinti";
                  publishTestBtn.addEventListener("click", () => {
                    alert("One day this will publish stuff");
                    // const testObject = tests[key].test;
                    // const accessibleTest = {
                    //   name: testObject.title,
                    //   description: testObject.description,
                    //   specialSymbols: testObject.specialSymbols,
                    //   questions: testObject.questions.map((q) => ({
                    //     number: q.number,
                    //     question: q.question,
                    //     points: q.points,
                    //     isAdditional: q.isAdditional,
                    //   })),
                    // };

                    // const accessibleTestRef = ref(db, "accessibleTests/" + key);
                    // set(accessibleTestRef, accessibleTest);
                    // alert(
                    //   `Testas "${testObject.title}" (kodas: ${key}) sėkmingai paviešintas!`
                    // );
                  });
                  testItem.appendChild(publishTestBtn);
                }

                testList.appendChild(testItem);
                testList.appendChild(document.createElement("br"));
              }
            }
          });
        } else {
          window.location.href = "admin_login.html";
        }
      });

      const signOutButton = document.getElementById("signOutButton");
      signOutButton.addEventListener("click", () =>
        signOut(auth)
          .then(() => {
            window.location.href = "admin_login.html";
          })
          .catch((error) => {
            alert("Klaida atsijungiant: " + error.message);
            console.error("Signout error: " + error.message);
          })
      );

      const testList = document.getElementById("testList");
      const createTestBtn = document.getElementById("createTestBtn");
      createTestBtn.addEventListener("click", () => {
        window.location.href = "test_create.html";
      });
    </script>
  </head>
  <body>
    <h1>Mokytojo aplinka</h1>
    <div id="isLoggedIn">Esate ...</div>
    <button id="signOutButton" style="display: none">Atsijungti</button>
    <h2>Jūsų testai</h2>
    <div id="testList"></div>
    <button id="createTestBtn">Kurti naują testą</button>
  </body>
</html>
